#!/bin/bash

export ETHERNET=""
export BRIDGE_BRIDGE=wbr1
export NAT_BRIDGE=wbr0
export NAT_DNS_PORT=5353
export NAT_NETWORK=192.168.53.0
export NAT_NETMASK=255.255.255.0
export NAT_GATEWAY=192.168.53.1
export NAT_DHCPRANGE=192.168.53.2,192.168.53.254

progname="$(basename $0)"
usage() {

  echo "Usage: qemu-wrapper [options] [disk_image]"
  echo
  echo "'disk_image' is a raw hard disk image for IDE hard disk 0"
  echo
  echo "Standard options:"
  echo "-h or -help                  display this help and exit"
  echo "-br internet_interface       set the network mode to bridge (default is nat)"
  echo "-mac mac_address             set mac address"
  echo "-vnc                         enable vnc and assign ports in order"
  echo "-vda/-vdb/-vdc/-vdd file     set disk path"
  echo
  echo "Examples:"
  echo "  "$progname" -br eth0 -mac 52:54:91:2c:1e:8d -vnc fedora.qcow2"
  echo "  "$progname" -vda fedora.qcow2 -kernel bzImage -append \"root=/dev/vda1 console=ttyS0\" -serial stdio"
}

if [[ -z $1 ]] || [[ $1 = "-h" ]] || [[ $1 = "-help" ]]; then
  usage
  exit 0
fi

is_bridge_interface() {
    [[ -z "$1" ]] && return 1
    [[ -d "/sys/class/net/${1}/bridge" ]]
}
export -f is_bridge_interface

vda=""
vdb=""
vdc=""
vdd=""
smp=" -smp 1 "
mem=" -m 2g "
net=nat
vnc=""
mac_addr=""
printf -v mac_addr '52:54:%02x:%02x:%02x:%02x' $(( $RANDOM & 0xff)) $(( $RANDOM & 0xff )) $(( $RANDOM & 0xff)) $(( $RANDOM & 0xff ))

args=("$@")
for ((i=$(("${#args[@]}" - 1)); i > -1 ; --i)); do
  case ${args[i]} in
  -smp)
    smp=""
    ;;
  -m)
    mem=""
    ;;
  -vda)
    vda=" -drive file=${args[i+1]},if=virtio "
    unset args[i]
    unset args[i+1]
    ;;
  -vdb)
    vdb=" -drive file=${args[i+1]},if=virtio "
    unset args[i]
    unset args[i+1]
    ;;
  -vdc)
    vdc=" -drive file=${args[i+1]},if=virtio "
    unset args[i]
    unset args[i+1]
    ;;
  -vdd)
    vdd=" -drive file=${args[i+1]},if=virtio "
    unset args[i]
    unset args[i+1]
    ;;
  -mac)
    mac_addr=${args[i+1]}
    unset args[i]
    unset args[i+1]
    ;;
  -br)
    ETHERNET=${args[i+1]}
    net=bridge
    unset args[i]
    unset args[i+1]
    ;;
  -vnc)
    if [[ ${args[i+1]} != :* ]]; then
      vnc=" -vnc :"$(($(comm -3 <(seq 5900 6000) <(ss -nltp | grep "\"qemu-system-x86\"" | awk '{print $4}' | grep -Eo "[0-9]+$" | sort -V | uniq) | head -n 1) - 5900))
      unset args[i]
    fi
    ;;
  esac
done

echo mac address : $mac_addr

qemu-system-x86_64 -enable-kvm $smp $mem -cpu host \
  -netdev tap,id=tap0,script=/etc/qemu-wrapper-ifup-$net,downscript=/etc/qemu-wrapper-ifdown-$net \
  -device virtio-net,netdev=tap0,mac=$mac_addr \
  -device virtio-rng-pci \
  $vda $vdb $vdc $vdd $vnc "${args[@]}"

